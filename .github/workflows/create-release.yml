on:
  pull_request:
    branches:
    - main
    types: [closed]

name: '[autorelease] Create release'

permissions:
  contents: read

jobs:
  can-run:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'autorelease')
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit
      - run: echo 'Running create release!'
  # Python
  build-compiled-python:
    runs-on: ${{ matrix.platform.runner }}
    needs: can-run
    defaults:
      run:
        working-directory: bindings/python
        shell: bash
    permissions:
      id-token: write
    strategy:
      matrix:
        platform:
          - runner: ubuntu-latest
            cargo-target: x86_64
            python-target: x64
            manylinux: auto
            name: linux
          - runner: ubuntu-latest
            cargo-target: x86
            python-target: x64
            manylinux: auto
            name: linux
          - runner: ubuntu-latest
            cargo-target: aarch64
            python-target: x64
            manylinux: auto
            name: linux
          - runner: ubuntu-latest
            cargo-target: armv7
            python-target: x64
            manylinux: auto
            name: linux
          - runner: ubuntu-latest
            cargo-target: s390x
            python-target: x64
            manylinux: auto
            name: linux
          - runner: ubuntu-latest
            cargo-target: ppc64le
            python-target: x64
            manylinux: auto
            name: linux
          - runner: ubuntu-latest
            cargo-target: x86_64
            python-target: x64
            manylinux: musllinux_1_2
            name: musllinux
          - runner: ubuntu-latest
            cargo-target: x86
            python-target: x64
            manylinux: musllinux_1_2
            name: musllinux
          - runner: ubuntu-latest
            cargo-target: aarch64
            python-target: x64
            manylinux: musllinux_1_2
            name: musllinux
          - runner: ubuntu-latest
            cargo-target: armv7
            python-target: x64
            manylinux: musllinux_1_2
            name: musllinux
          - runner: windows-latest
            cargo-target: x64
            python-target: x64
            manylinux: auto
            name: windows
          - runner: windows-latest
            cargo-target: x86
            python-target: x86
            manylinux: auto
            name: windows
          - runner: macos-14
            cargo-target: aarch64
            python-target: arm64
            manylinux: auto
            name: macos
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          submodules: recursive
      - uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # 6.0.0
        with:
          python-version: "3"
          architecture: ${{ matrix.platform.python-target }}
      - name: Build wheels
        uses: PyO3/maturin-action@86b9d133d34bc1b40018696f782949dac11bd380 # v1.49.4
        with:
          target: ${{ matrix.platform.cargo-target }}
          args: --release --out wheels-${{ matrix.platform.name }}-${{ matrix.platform.cargo-target }} --find-interpreter
          sccache: 'true'
          manylinux: ${{ matrix.platform.manylinux }}
          working-directory: bindings/python
      - name: Fix permissions
        if: ${{ matrix.platform.runner == 'ubuntu-latest' }}
        run: sudo chown --recursive $(id -u):$(id -g) wheels-* && sudo chmod --recursive u+rw wheels-*
      - name: Sign the dists with Sigstore
        uses: sigstore/gh-action-sigstore-python@f832326173235dcb00dd5d92cd3f353de3188e6c # v3.1.0
        with:
          inputs: |
            bindings/python/wheels-*/*.whl
      - name: Upload wheels
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: wheels-${{ matrix.platform.name }}-${{ matrix.platform.cargo-target }}
          path: bindings/python/wheels-${{ matrix.platform.name }}-${{ matrix.platform.cargo-target }}

  build-source-python:
    runs-on: ubuntu-latest
    needs: can-run
    defaults:
      run:
        shell: bash
    permissions:
      id-token: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          submodules: recursive
      - uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: "3"
      - name: Prepare Python sdist
        run: 'python scripts/prepare_python_sdist.py $GITHUB_SHA'
      - name: Build sdist
        uses: PyO3/maturin-action@86b9d133d34bc1b40018696f782949dac11bd380 # v1.49.4
        with:
          command: sdist
          args: --out wheels-source
          working-directory: bindings/python
      - name: Sign the dists with Sigstore
        uses: sigstore/gh-action-sigstore-python@f832326173235dcb00dd5d92cd3f353de3188e6c # v3.1.0
        with:
          inputs: |
            bindings/python/wheels-*/*.tar.gz
      - name: Upload sdist
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: wheels-sdist
          path: bindings/python/wheels-source

  # C: TODO
  # C++: TODO

  github-release:
    needs: [build-compiled-python, build-source-python]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Set git config to submitter.
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR_ID}+${GITHUB_ACTOR}@users.noreply.github.com"

      - name: Get release version
        id: get-release-version
        env:
          PULL_REQUEST_HEAD_REF: ${{ github.event.pull_request.head.ref }}
        run: |
          # Head branch should be named autorelease/<version>
          if ! [[ "${PULL_REQUEST_HEAD_REF}" =~ ^autorelease\/[A-Za-z0-9.+-]+$ ]]; then
            echo "Invalid branch"
            exit 1
          fi
          VERSION=$(echo "${PULL_REQUEST_HEAD_REF}" | awk -F/ '{print $2}')
          echo "VERSION=$VERSION"
          echo "name=release-version::$VERSION" >> $GITHUB_OUTPUT

      - name: Get release notes
        id: query-release-info
        uses: release-flow/keep-a-changelog-action@74931dec7ecdbfc8e38ac9ae7e8dd84c08db2f32 # v3.0.0
        with:
          command: query
          version: latest

      - name: Display release notes
        run: |
          echo "${{ steps.query-release-info.outputs.release-notes }}"

      - name: Write release notes
        run: |
          echo "${{ steps.query-release-info.outputs.release-notes }}" > release.log

      - name: Display release version
        run: |
          echo "GIT=${{ steps.get-release-version.outputs.release-version }}"
          echo "CHANGELOG=${{ steps.query-release-info.outputs.version }}"

      - uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
      - name: 'Setup Python'
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: '3'
      - name: Create Python Archive
        run: 'python scripts/create_release_package.py'

      - name: Create Tag
        run: |
          next_version=v${{ steps.query-release-info.outputs.version }}
          git tag -a '${next_version}' -m 'Preparing release: ${next_version}'
          git push --follow-tags
      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: >-
          gh release create
          'v${{ steps.query-release-info.outputs.version }}'
          --repo '${{ github.repository }}'
          --title 'Release ${{ steps.query-release-info.outputs.version }}'
          --notes-file release.log
      - name: Upload artifact signatures to GitHub Release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        # Upload to GitHub Release using the `gh` CLI.
        # `dist/` contains the built packages, and the
        # sigstore-produced signatures and certificates.
        run: >-
          gh release upload
          'v${{ steps.query-release-info.outputs.version }}' python-wheels.tar.gz
          --repo '${{ github.repository }}'

  python-pypi-release:
    needs: github-release
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'autorelease')
    environment: release
    permissions:
      id-token: write  # IMPORTANT: mandatory for trusted publishing
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit
      - uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
      - name: Publish to PyPI
        uses: PyO3/maturin-action@86b9d133d34bc1b40018696f782949dac11bd380 # v1.49.4
        with:
          command: upload
          args: --non-interactive --skip-existing wheels-*/*.whl wheels-*/*.tar.gz

  rust-crates-release:
    needs: github-release
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'autorelease')
    environment: release
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
      - uses: dtolnay/rust-toolchain@4305c38b25d97ef35a8ad1f985ccf2d2242004f2 # stable
      - uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1 # v2.8.1
        with:
          shared-key: release-${{runner.os}}
      - name: Publish to Crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish
